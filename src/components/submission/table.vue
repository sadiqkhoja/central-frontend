<!--
Copyright 2019 ODK Central Developers
See the NOTICE file at the top-level directory of this distribution and at
https://github.com/getodk/central-frontend/blob/master/NOTICE.

This file is part of ODK Central. It is subject to the license terms in
the LICENSE file found in the top-level directory of this distribution and at
https://www.apache.org/licenses/LICENSE-2.0. No part of ODK Central,
including this file, may be copied, modified, propagated, or distributed
except according to the terms contained in the LICENSE file.
-->
<template>
  <table-freeze v-if="project.dataExists" id="submission-table" ref="table"
    :data="chunkyOData" key-prop="__id" :frozen-only="fields == null" divider
    @action="handleActions">
    <template #head-frozen>
      <th><span class="sr-only">{{ $t('common.rowNumber') }}</span></th>
      <th v-if="!draft">{{ $t('header.submitterName') }}</th>
      <th>{{ $t('header.submissionDate') }}</th>
      <th v-if="!draft && !deleted">{{ $t('header.stateAndActions') }}</th>
      <th v-if="!draft && deleted">{{ $t('header.deletedAt') }}</th>
    </template>
    <template #head-scrolling>
      <template v-if="fields != null">
        <th v-for="field of fields" :key="field.path">
          <span v-tooltip.text>{{ field.header }}</span>
        </th>
      </template>
      <th>{{ $t('header.instanceId') }}</th>
    </template>

    <template #data-frozen="{ data, index }">
      <submission-metadata-row :project-id="projectId" :xml-form-id="xmlFormId"
        :draft="draft" :submission="data" :deleted="deleted" :awaiting-response="awaitingDeletedResponses.has(data.__id)"
        :row-number="odata.originalCount - index" :can-update="canUpdate"/>
    </template>
    <template #data-scrolling="{ data }">
      <submission-data-row :project-id="projectId" :xml-form-id="xmlFormId"
        :draft="draft" :submission="data" :fields="fields"/>
    </template>
  </table-freeze>
</template>

<script setup>
import { computed, ref } from 'vue';

import SubmissionDataRow from './data-row.vue';
import SubmissionMetadataRow from './metadata-row.vue';
import TableFreeze from '../table-freeze.vue';

import useChunkyArray from '../../composables/chunky-array';
import { markRowsChanged, markRowsDeleted } from '../../util/dom';
import { useRequestData } from '../../request-data';

defineOptions({
  name: 'SubmissionTable'
});
defineProps({
  projectId: {
    type: String,
    required: true
  },
  xmlFormId: {
    type: String,
    required: true
  },
  deleted: {
    type: Boolean,
    required: true
  },
  draft: Boolean,
  fields: Array
});
const emit = defineEmits(['review', 'delete', 'restore']);

// The component does not assume that this data will exist when the component is
// created.
const { project, odata } = useRequestData();

const chunkyOData = useChunkyArray(computed(() => odata.value));
const canUpdate = computed(() =>
  project.dataExists && project.permits('submission.update'));

const handleActions = ({ target, data }) => {
  if (target.classList.contains('review-button')) emit('review', data);
  if (target.classList.contains('delete-button')) emit('delete', data);
  if (target.classList.contains('restore-button')) emit('restore', data);
};
const table = ref(null);
const afterReview = (index) => { markRowsChanged(table.value.getRowPair(index)); };
const afterDelete = (index) => { markRowsDeleted(table.value.getRowPair(index)); };

const awaitingDeletedResponses = ref(new Set());
const setAwaitingDeletedResponse = (instanceId, value) => {
  if (value) {
    awaitingDeletedResponses.value.add(instanceId);
  } else {
    awaitingDeletedResponses.value.delete(instanceId);
  }
};

defineExpose({ afterReview, afterDelete, setAwaitingDeletedResponse });
</script>

<style lang="scss">
@import '../../assets/scss/mixins';

#submission-table .table-freeze-scrolling {
  th, td {
    @include text-overflow-ellipsis;
    max-width: 250px;
    &:last-child { max-width: 325px; }
  }
}
</style>

<i18n lang="json5">
{
  "en": {
    "header": {
      "stateAndActions": "State and actions"
    }
  }
}
</i18n>

<!-- Autogenerated by destructure.js -->
<i18n>
{
  "cs": {
    "header": {
      "stateAndActions": "Stav a akce"
    }
  },
  "de": {
    "header": {
      "stateAndActions": "Status und Aktionen"
    }
  },
  "es": {
    "header": {
      "stateAndActions": "Estado y acciones"
    }
  },
  "fr": {
    "header": {
      "stateAndActions": "État et actions"
    }
  },
  "id": {
    "header": {
      "stateAndActions": "Status dan tindakan"
    }
  },
  "it": {
    "header": {
      "stateAndActions": "Stato e azioni"
    }
  },
  "ja": {
    "header": {
      "stateAndActions": "レビュー・ステータスと操作"
    }
  },
  "sw": {
    "header": {
      "stateAndActions": "Hali na vitendo"
    }
  },
  "zh-Hant": {
    "header": {
      "stateAndActions": "狀態和動作"
    }
  }
}
</i18n>
